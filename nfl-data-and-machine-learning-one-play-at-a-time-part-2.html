<!doctype html>
<html lang="en" itemscope itemtype="http://schema.org/Person">
<head>
  <meta charset="utf-8">
  <!-- Site Meta Data -->
  <title>NFL Data and Machine Learning… One Play at a Time — Part 2</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="">
  <meta name="author" content="Michael Skrzypiec">

  <link rel="shortcut icon" href="/theme/images/icons/favicon.ico">

  <!-- schema.org -->
  <meta itemprop="name" content="Michael Skrzypiec">
  <meta itemprop="image" content="/theme/images/me_small.jpg">
  <meta itemprop="description" content="">

  <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,600,700' rel='stylesheet' type='text/css'>
  <!-- Style Meta Data -->
  <link rel="stylesheet" href="/theme/css/style.css" type="text/css" />
  <link rel="stylesheet" href="/theme/css/pygments.css" type="text/css" />

  <!-- Feed Meta Data -->

  <!-- Twitter Feed -->
  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="skrzym">
  <meta name="twitter:image" content="">

<meta name="twitter:creator" content="skrzym">
<meta name="twitter:url" content="/nfl-data-and-machine-learning-one-play-at-a-time-part-2.html">
<meta name="twitter:title" content="Michael Skrzypiec ~ NFL Data and Machine Learning… One Play at a Time — Part 2">
<meta name="twitter:description" content="Deeper dive into the NFL data, make a basic model to choose the right play given a specific game scenario, and showcase a web app developed to run the model whenever, wherever you want.">

<!-- Facebook Meta Data -->
<meta property="og:title" content="Michael Skrzypiec ~ NFL Data and Machine Learning… One Play at a Time — Part 2" />
<meta property="og:description" content="Deeper dive into the NFL data, make a basic model to choose the right play given a specific game scenario, and showcase a web app developed to run the model whenever, wherever you want." />
<meta property="og:image" content="" />
</head>

<body>
  <!-- Sidebar -->
  <aside>
    <center><a href=""><img id="avatar" src="/theme/images/me_small.jpg"></a></center>
    <h1>Michael Skrzypiec</h1>
      <p>Data Analyst/Project Manager</p>
    <br>

      <a class="twitter-follow-button"
      href="https://twitter.com/skrzym"
      data-show-count="false"
      data-lang="en">
      Follow @twitterdev
      </a>
      <script type="text/javascript">
      window.twttr = (function (d, s, id) {
        var t, js, fjs = d.getElementsByTagName(s)[0];
        if (d.getElementById(id)) return;
        js = d.createElement(s); js.id = id;
        js.src= "https://platform.twitter.com/widgets.js";
        fjs.parentNode.insertBefore(js, fjs);
        return window.twttr || (t = { _e: [], ready: function (f) { t._e.push(f) } });
      }(document, "script", "twitter-wjs"));
      </script>

    <nav class="nav">
      <ul class="list-bare">

          <li><a class="nav__link" href="/blog.html">Recent Posts</a></li>
          <li><a class="nav__link" href="/categories.html">Categories</a></li>
          <li><a class="nav__link" href="/tags.html">Tags</a></li>
          <li><a class="nav__link" href="/#aboutme">About Me</a></li>


      </ul>
    </nav>

    <p class="social">
        <a href="https://www.linkedin.com/in/michaelskrzypiec" target="_blank" ><img src="/theme/images/icons/linkedin.png"></a>
        <a href="https://github.com/skrzym" target="_blank" ><img src="/theme/images/icons/github.png"></a>
        <a href="https://twitter.com/skrzym" target="_blank" ><img src="/theme/images/icons/twitter.png"></a>
    </p>



  </aside>

  <!-- Content -->
  <article>
<section id="content">
    <article>
        <h2 class="post_title post_detail"><a href="/nfl-data-and-machine-learning-one-play-at-a-time-part-2.html" rel="bookmark" title="Permalink to NFL Data and Machine Learning… One Play at a Time — Part 2">NFL Data and Machine Learning… One Play at a Time — Part 2</a></h2>
        <div class="entry-content blog-post">
            <p><em>How to wrangle NFL play-by-play data into a predictive machine.</em></p>
<p><em>In this post we get more technical about our data, make a basic model to choose
the right play given a specific game scenario, and showcase a web app developed
to run the model whenever, wherever you want.</em></p>
<p><em>Part one investigated our data-set provided by the NFL APIs since the 2009
season and explored it in different ways. We looked at a few different
visualizations of the game and dug into how a rule change back in 2015 could be
detected in the data.</em></p>
<p><em>Part three will take this model one step further and incorporate some more
advanced methods to indicate which actions on a play lead to positive or
negative outcomes.</em></p>
<h3>The Data</h3>
<p>Our data comes from the NFL via their publicly available API with detailed stats
on every play since the 2009 season. We will use Python and a tiny bit of R to
analyze, build, and train our model with such packages as pandas, numpy, and
scikit-learn. To help wrangle the very dense and messy data that comes from the
NFL there are two great projects that have done a ton of work to tidy everything
up. One is for python, <a href="https://pypi.python.org/pypi/nflgame">nflgame</a>, and the
other is for R, <a href="https://github.com/maksimhorowitz/nflscrapR">nflscrapR</a>. The
python package puts a stronger emphasis on answering player and team stat
questions like “Which 5 players had the most rushing yards for week 1 of the
2017 season?” The R package can answer the same question but it’s more Data
Frame focused so to get the same answer a bit more code is required.</p>
<p>For our purposes the play-by-play Data Frames created by the R package perfectly
suite our needs. We generate data frames for each NFL season’s regular and
postseason data since 2009. Below is the R script I used to not only make these
data frames but also save them as csv files for loading everything into a python
workspace.</p>
<div class="highlight"><pre><span></span><span class="kn">library</span><span class="p">(</span>nflscrapR<span class="p">)</span>

season_to_csv <span class="o">&lt;-</span> <span class="kr">function</span><span class="p">(</span>years<span class="p">,</span>playoffs<span class="p">){</span>
    <span class="kr">for</span> <span class="p">(</span>season <span class="kr">in</span> years<span class="p">){</span>
        <span class="kr">if</span> <span class="p">(</span>playoffs<span class="p">)</span> <span class="p">{</span>
            <span class="kp">print</span><span class="p">(</span><span class="kp">paste</span><span class="p">(</span><span class="s">&#39;Extracting Playoff Games from&#39;</span><span class="p">,</span>season<span class="p">,</span><span class="s">&#39;season...&#39;</span><span class="p">))</span>
            po <span class="o">&lt;-</span> extracting_gameids<span class="p">(</span>season<span class="p">,</span><span class="kc">TRUE</span><span class="p">)</span>
            count <span class="o">=</span> <span class="m">0</span>
            <span class="kr">for</span> <span class="p">(</span>game <span class="kr">in</span> po<span class="p">){</span>
                <span class="kp">print</span><span class="p">(</span><span class="kp">paste</span><span class="p">(</span><span class="s">&#39;Game &#39;</span><span class="p">,</span> count<span class="p">,</span> <span class="s">&#39; of &#39;</span><span class="p">,</span> <span class="kp">length</span><span class="p">(</span>po<span class="p">)))</span>
                write.csv<span class="p">(</span>game_play_by_play<span class="p">(</span>game<span class="p">),</span><span class="kp">paste</span><span class="p">(</span><span class="s">&#39;po_pbp_&#39;</span><span class="p">,</span>season<span class="p">,</span><span class="s">&#39;.csv&#39;</span><span class="p">))</span>
                count <span class="o">&lt;-</span> count <span class="o">+</span> <span class="m">1</span>
            <span class="p">}</span>    
        <span class="p">}</span> <span class="kr">else</span> <span class="p">{</span>
            <span class="kp">print</span><span class="p">(</span><span class="kp">paste</span><span class="p">(</span><span class="s">&#39;Extracting Season Games from&#39;</span><span class="p">,</span>season<span class="p">,</span><span class="s">&#39;season...&#39;</span><span class="p">))</span>
            rs <span class="o">&lt;-</span> season_play_by_play<span class="p">(</span>season<span class="p">,</span>playoffs<span class="p">)</span>
            write.csv<span class="p">(</span>rs<span class="p">,</span><span class="kp">paste</span><span class="p">(</span><span class="s">&#39;rs_pbp_&#39;</span><span class="p">,</span>season<span class="p">,</span><span class="s">&#39;.csv&#39;</span><span class="p">))</span>
        <span class="p">}</span>
    <span class="p">}</span>    
<span class="p">}</span>
</pre></div>


<p>Next we use pandas to pull these files into our python(3) workspace and generate
one huge combined pandas data frame to work with. All said and done our data
frame contains 329,373 plays with 81 columns of details about each one. Now we
don’t need all 81 columns. Each play can turn out a number of ways and most of
these columns are not the most relevant for each play such as what the game ID
is, the date, the current drive number, etc. but in addition to that some of
this data is actually dangerous to include in our model. More on that soon. Here
is what we are using from the data to build our model.</p>
<h4>Quarter</h4>
<p>Integer of 1, 2, 3, or 4 indicating what quarter of the game it is.</p>
<h4><strong>Time Remaining</strong></h4>
<p>This is set to the current <strong>minute</strong> of the game ignoring the number of seconds
remaining.</p>
<h4><strong>Down</strong></h4>
<p>1, 2, 3, or 4. Yes, integer values.</p>
<h4><strong>Yards to 1st Down</strong></h4>
<p>Any integer from 1 to however terrible of a situation a team has gotten
themselves into… bad things happen and this model is trying to help that =).</p>
<h4><strong>Field Position</strong></h4>
<p>From 1 to 100 yards away from scoring a touchdown. This means if your on your
own 25, this number would show 75 yards to the goal.</p>
<h4><strong>Score Difference</strong></h4>
<p>This can be a positive or negative integer indicating if the team is up, down,
or tied by some number of points.</p>
<h4><strong>Play Type</strong></h4>
<p>The final piece of our model. It indicates if the play was a pass, run, field
goal, punt, or QB kneel. This is what our model will be trying to predict given
all the other inputs we’ve described.</p>
<p>Now after reading this some you may be saying:</p>
<blockquote>
<p>Why did you pick these pieces of information to build the model? Why ignore all
that other information in the data?! Why aren’t you incorporating “_____”?</p>
</blockquote>
<p>Here’s why. When its game time and you are either playing or watching it, what
key pieces of information do you have about a play before it starts? The
announcer typically says something like this, “Its 1st and 10 at the 20 yard
line. Dallas is down by 3 with 2 minutes to go in the game.” If you parse that
information down into the key points you’ll notice all the inputs described
above are in there. That is the basic set of information you get each and every
play. The key thing we are doing with our model is seeing how can we take over a
quarter million of these game scenarios and try and have it predict what should
happen next. Let’s explore the different play types we will be trying to get our
model to predict.</p>
<h3>The Choices</h3>
<p>Each play has five basic options to pick from:</p>
<ol>
<li>Pass</li>
<li>Run</li>
<li>Punt</li>
<li>Field Goal</li>
<li>Kneel</li>
</ol>
<p>A typical play has these five options that the offense can use to move the game
along in their favor given the current situation. There is also much more data
available for these options vs other edge cases which make predicting when and
how to use <em>these</em> options with more data more reliable and less complicated.</p>
<p>Let’s see the historical breakdown of these five different play options.</p>
<p><img alt="Chart 1" src="https://cdn-images-1.medium.com/max/1600/1*cno0BInUutYcIgOwVY3cyA.png" /></p>
<p>Not too surprising that passing and running the ball dominate decisions made.
These are a team’s go to ways to move the ball down the field, but both have
many game time factors that go into which option to choose and how to execute
them successfully.</p>
<p>Next up is punting the ball (aka a failed drive). Teams pick this option because
they aren’t in field goal range and its 4th down and too many yards to risk
turning the ball over to the opposing team at an unfavorable field position. So
why include this decision in our model? We want to see if it can determine 4th
down situations where going for it is worth the risk. Knowing when you have the
best chance at a successful 4th down attempt can make this decision easier and
potentially get your failed drive back on track.</p>
<p>Field Goals are pretty straight forward given certain game scenarios, but just
like with punting, the decision to kick vs pass or run could be
counter-intuitive. We should be able to determine for each yard what your
chances for a successful kick are and analyze this choice given the game
scenario.</p>
<p>The QB Kneel is typically used as a delay tactic towards the end of either half
to safeguard the ball when a team is winning and doesn’t want to risk a
turnover. The QB Kneel very rarely happens outside of this specific gaming
situation so our model should be able to recognize this and we use this as a
sanity check to ensure it’s not telling us to kneel when we are losing and 5
yards from scoring a comeback touchdown.</p>
<h3>Building the model</h3>
<p>If you notice, nowhere are we saying that the model will indicate if a play is a
good or bad one, just that this is the most likely given the inputs provided.
Why? Well there’s the next post for that! But really, here we assume each play’s
outcome was decided by a team that had an interest in winning the game. A team
won’t make a play to intentionally turn the ball over. Heck the QB Kneel where a
team rather do absolutely nothing than lose the ball is a testament to that.
This model combines all that experience and smart NFL decision making together.
So while the model isn’t specifically searching for the positive or negative
outcomes of a play, we will assume that it’s built into our data.</p>
<p>Each <em>Play Type</em> can be considered a different “class” which labels the set of
inputs associated with it as promoting that outcome. We can use a random forest
multi-class classification method to build a model that can take a game scenario
like we described and spit out probabilities of what <em>Play Type</em> it most likely
should be, given the quarter million other game scenarios that have happened in
the past.</p>
<p>There are a few key points to how our data is structured and the kind of
training we will be doing that we need to discuss. First, our data is quite
imbalanced. We have far more passing plays than QB kneels. We need to ensure our
model won’t be biased to predicting classes that we have a plethora of data for.
We can accomplish this using a cross validation method called <em>Stratified
K-Folding</em>. All this means is when we train our model we will not only break the
training data down into K groups, we will ensure that in each group there are an
equal number of classes represented for training. Using any version of K-fold
cross validation is designed to reduce our chances of over-fitting our training
data and ensuring our model is as generalized as possible so when we look at new
data, say the 2017 season, it will hopefully perform as well as we have seen in
our training. Now scikit-learn is pretty smart in this regard since it can
detect this imbalance for certain models and automatically use a stratified
k-fold vs a regular one. In this model we will be explicit about telling
scikit-learn to use a stratified version.</p>
<p>We also need to tune our model for the different hyper parameters used in a
random forest. Specifically we will use a technique called grid search to run
our model for various combinations of hyper parameters and determine which
combination performed the best and use those parameters in our final model.</p>
<p><img alt="Chart 2" src="https://cdn-images-1.medium.com/max/1600/1*TseTrZ-aj9Y_Mwz14T8yAw.png" /></p>
<p>As we can see from above the model does a great job of classifying punts, field
goals, and QB Kneels. However, Those two curved lines are pass and run
predictions. These values tend to get confused by our current model it seems. It
is still quite effective at predicting them, but just not as effective as the
other parts of our model. This is worth a follow up with more factors, deeper
investigation, or new metrics to build the model against to try and discern even
more when a play will be a pass or a run.</p>
<p>So what’s the final verdict on this fancy magic forest of predictive power?
About 70% accuracy. (Mainly due to the confusion between passing and running). I
will say though I am very impressed the model could discern the less common play
types so well, as these situations have much less data here. This just means
what is available compared to what we have for passing and running makes the
plays standout to the model and it developed strong decision rules around those
game scenarios.</p>
<p>If you want to see this model in action you can head over to <a href="http://34.212.37.176/">Monday Morning
Quarterback</a> <em>(Currently just an amazon EC2 server
hosting this webapp, once I feel it’s got all the tweaks done I’ll push
everything over to a more dedicated page)</em>.</p>
<p>The site is designed to let you come up with a game scenario, put in a guess for
what you think the play is going to be, and it will compute the probabilities
for each so you can see how right or wrong you were when compared to this model
built on hundreds of thousands of different game scenarios.</p>
<p>Hope you enjoyed reading! The next post will take this model and try to morph it
to answer the question of “How good is the decision to run this play type for
this game scenario?”. We will discuss building a metric to help classify good
from bad plays and some challenges that currently face scientists who try and
build various kinds of models like this.</p>
<p><em>The code for this blog post series is available on my </em><a href="https://github.com/skrzym">GitHub
</a><em>under Monday Morning Quarterback.</em></p>
<hr />
<p><strong>Thanks for reading!</strong></p>
<p><strong>Feel free to reach out to me via the links below.</strong></p>
<p><a href="https://www.linkedin.com/in/michaelskrzypiec/">LinkedIn</a><strong> |
</strong><a href="https://twitter.com/Skrzym">Twitter</a><strong> | </strong><a href="https://github.com/skrzym">GitHub
</a><strong>| </strong><a href="http://www.michaelskrzypiec.com/">Website</a></p>
<p>**See this post on Medium <a href="https://medium.com/@skrzym/nfl-data-and-machine-learning-one-play-at-a-time-part-2-1daa1901c0a3">here</a></p>
        </div>
        <div class="post_list">
            <span>By </span>
            <a href="/author/michael-skrzypiec.html">@Michael Skrzypiec</a>
            <span> in </span>
            <span class="post_category"><a href="/category/data-science.html" rel="bookmark" title="Permalink to Data Science">[ Data Science ]</a></span>
            <span class="post_date">Mon 02 October 2017</span>
            <div><span>Tags : </span>
                <span><a href="/tag/nfl.html">#NFL, </a></span>
                <span><a href="/tag/python.html">#Python, </a></span>
                <span><a href="/tag/machine-learning.html">#Machine Learning, </a></span>
                <span><a href="/tag/random-forest.html">#Random Forest, </a></span>
                <span><a href="/tag/classification.html">#Classification, </a></span>
            </div>

            <div class="entry-social">
                <span class="twitter"><a target="_blank" rel="nofollow" onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=400,width=700');return false;" title="Twitter" href="https://twitter.com/share?url=/nfl-data-and-machine-learning-one-play-at-a-time-part-2.html&text=NFL Data and Machine Learning… One Play at a Time — Part 2&via=skrzym"><img src="/theme/images/icons/twitter-s.png"></a></span>

                <span class="gplus"><a target="_blank" title="Google +" href="https://plus.google.com/share?url=/nfl-data-and-machine-learning-one-play-at-a-time-part-2.html&hl=fr" rel="nofollow" onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=450,width=650');return false;"><img src="/theme/images/icons/google-s.png"></a></span>

                <span class="facebook"><a target="_blank" title="Facebook" rel="nofollow" onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=500,width=700');return false;" href="https://www.facebook.com/sharer.php?u=/nfl-data-and-machine-learning-one-play-at-a-time-part-2.html&t=NFL Data and Machine Learning… One Play at a Time — Part 2"><img src="/theme/images/icons/facebook-s.png"></a></span>

                <a  target="_blank" title="Linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=/nfl-data-and-machine-learning-one-play-at-a-time-part-2.html&title=NFL Data and Machine Learning… One Play at a Time — Part 2" rel="nofollow" onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=450,width=650');return false;"><img src="/theme/images/icons/linkedin-s.png"></a>

                <span class="mail"><a href="mailto:?subject=NFL Data and Machine Learning… One Play at a Time — Part 2&amp;body=Viens découvrir un article à propos de [NFL Data and Machine Learning… One Play at a Time — Part 2] sur le site de Michael Skrzypiec. /nfl-data-and-machine-learning-one-play-at-a-time-part-2.html" title="Share by Email" target="_blank"><img src="/theme/images/icons/mail-s.png"></a></span>
            </div>
        </div>
    </article>
</section>
<!-- JupyterStyleSheet -->
<link rel="stylesheet" href="/theme/css/ipynb.css" type="text/css" />
  </article>

  <!-- Footer -->
  <footer>
    <p>
      Blog powered by <a href="http://getpelican.com/">Pelican</a>,
      which takes great advantage of <a href="http://python.org">Python</a>.
      Theme <a href="https://github.com/parbhat/pelican-blue">Pelican-Blue</a> by <a href="https://parbhatpuri.com/">@parbhat</a>.
    </p>
  </footer>


</body>
</html>